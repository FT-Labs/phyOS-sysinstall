#!/bin/sh

# cryptdev=$(lsblk -f -r | grep crypto_LUKS | awk '{print $1}' | while read d; do
#     cdev=$(lsblk -r /dev/$d | awk '{print $NF}' | grep -w "/" &> /dev/null && sudo cryptsetup luksUUID /dev/$d)
#     [[ ! -z $cdev ]] && echo $cdev && break
# done
# )
root=$(mount | grep -w '/' | awk '{print $1}' | rev | cut -d '/' -f 1 | rev)
is_lvm=$(sudo lvs -o lv_name | awk '{if(NR>1)print}' | tr -d " " | while read lv; do findmnt -l | grep '/dev/\S\+' | awk '{print $2}' | grep $lv; done)
[[ $(echo "$is_lvm" | grep "$root") ]] && \
	cryptdev=$(sudo dmsetup deps -o devname | grep $root | awk '{print $NF}' | tr -d "()" | sudo xargs dmsetup deps -o devname | awk '{print "/dev/"$NF}' | tr -d "()" | sudo xargs cryptsetup luksUUID) ||
	cryptdev=$(sudo dmsetup deps -o devname | grep "$root" | awk '{print "/dev/"$NF}' | tr -d "()" | sudo xargs cryptsetup luksUUID)

[[ $? != 0 ]] && exit 1
cryptdevice="    cryptdevice=UUID=$cryptdev:root"

sudo sed -i "36s/.*/$cryptdevice/" /usr/lib/initcpio/hooks/phy-encrypt
sudo sed -i "36s/.*/$cryptdevice/" /usr/lib/initcpio/hooks/phy-ply-encrypt
exit 0
